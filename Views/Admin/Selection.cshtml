
@{
    Layout = "_Admin";
}

@using LK2.Models
@{
    var categories = ViewBag.Categories as List<CategoryProductLanguage>;
    var products = ViewBag.Products as List<ProductLanguage>;
}

<div class="section">
    <h2 class="header center black-text">LISTA PRODOTTI</h2>

    <div class="row">
        <ul class="collapsible">
            @foreach(var category in categories) {
            <!-- LISTA CATEGORIE PRODOTTI -->
            <li>
                <div class="collapsible-header"><i class="material-icons">folder_open</i>@category.Name (@products.Where(p => p.Product.CategoryProductID.Equals(category.CategoryProductID)).Count())</div>
                <div class="collapsible-body grey lighten-5">
                    <!-- LISTA PRODOTTI DELLA CATEGORIA -->
                    <table class="striped">
                        <thead>
                            <tr>
                                <th>Posizione</th>
                                <th>Nome</th>
                                <th>Prezzo &euro;</th>
                                <th>Opzioni</th>
                            </tr>
                        </thead>

                        <tbody>
                            @foreach(var product in products.Where(p => p.Product.CategoryProductID.Equals(category.CategoryProductID)).OrderBy(p => p.Product.Position).ToList()) {
                            <tr>
                                <td>@product.Product.Position</td>
                                <td>@product.Name</td>
                                <td><input type="text" readonly name="price" class="price" id="@category.CategoryProductID-@product.ProductID" value="@product.Product.Price" /></td>
                                <td>
                                    <a href="javascript:;" class="edit"><i class="material-icons">edit</i></a>
                                    <a href="javascript:;" class="delete"><i class="material-icons">delete</i></a>
                                </td>
                            </tr>
                            }
                        </tbody>
                    </table>
                    <div class="center-align">
                        <a class="btn-floating btn-large waves-effect waves-light green"><i class="material-icons">add</i></a>
                    </div>
                </div>
            </li>
            }
        </ul>
    </div>
</div>

@section js {
    <script type="text/javascript">
        $(document).ready(function () {
            $('.collapsible').collapsible();

            $('.edit').click(function () {
                if ($(this).hasClass('save')) {
                    var $price = $(this).parents('tr').find('.price');
                    var catProd = $price.attr('id');
                    var split = catProd.split("-"); 
                    var categoryID = split[0];
                    var productID = split[1];

                    $.post("/Admin/Update",
                        {
                            categoryProductID: categoryID,
                            productID: productID,
                            price: $price.val()
                        },
                        function (data, status) {
                            alert("Data: " + data + "\nStatus: " + status);
                        });
                }
                else {
                    $(this).find('.material-icons').text('save');
                    $(this).toggleClass("save", true);
                    $(this).parents('tr').find('.price').attr("readonly", false);
                }
            });
        });
    </script>
}