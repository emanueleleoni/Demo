@using Microsoft.AspNetCore.Mvc.Localization
@* The IViewLocalizer can be injected into the view. It does two things of interest:
    1. It can HTML encode *parameters* passed to resource strings (not the resource strings themselves, as they may contain
       HTML) automatically, and return the result as an IHtmlContent so Razor won't HTML encode it again;
    2. It looks for localization resources for this view based on the view path, e.g. if the view's path is
       "MyApplication/Views/Home/Index.cshtml", then the corresponding resource base path will be "MyApplication.Views.Home.Index" *@
@inject IViewLocalizer Localizer
@using LK2.Models
@using LK2.ViewModels

@{
    var categories = ViewBag.Categories as List<CategoryProductLanguage>;
    var products = ViewBag.Products as List<ProductViewModel>;
}
<nav>
    <div class="nav-wrapper">
        <div class="col s12 center-align breadcrumbs">
            <a href="#!" class="breadcrumb">1. Selezione</a>
        </div>
    </div>
</nav>
<div class="section step0">
    <h2 class="header center black-text">SELEZIONA IL PRODOTTO</h2>
    <div class="row ">
        @foreach (var category in categories)
        {
            <a href="javascript:;" data-content="cat@(category.CategoryProductID)">
                <div class="col s12 m4">
                    <div class="card horizontal">
                        <div class="card-image">
                            <img height="115" src="@category.CategoryProduct.Image" />
                        </div>
                        <div class="card-stacked">
                            <div class="card-content">
                                <p style="font-weight:bold; font-size:16px;">@category.Name</p>
                            </div>
                        </div>
                    </div>
                </div>
            </a>
        }
    </div>
</div>

@foreach (var category in categories)
{
    <div class="section step1 hidden" id="cat@(category.CategoryProductID)">
        <h2 class="header center black-text">SELEZIONA IL PRODOTTO</h2>
        <a class="waves-effect btn-small go-back"><i class="material-icons left">home</i>INDIETRO</a>
        <div class="row">
            @foreach (var product in products.Where(p => p.categoryID.Equals(category.CategoryProductID)))
            {
                <a href="javascript:;" data-content="prod@(product.productID)">
                    <div class="col s12 m4">
                        <div class="card horizontal">
                            <div class="card-image">
                                <img height="115" src="@product.image" />
                            </div>
                            <div class="card-stacked">
                                <div class="card-content">
                                    <p>@product.name</p>
                                    <p>@product.price &euro;</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </a>
            }
        </div>
    </div>
}

@foreach (var product in products)
{
    <div class="section step2 hidden" id="prod@(product.productID)">
        <h2 class="header center black-text">CONFERMA IL PRODOTTO</h2>

        <a class="waves-effect btn-small go-back"><i class="material-icons left">home</i>INDIETRO</a>
        <div class="row">
            <div class="col s12 m6">
                <img src="@product.image" width="100%" />
            </div>
            <div class="col s12 m6">
                <h1>@product.name</h1>
                <p>@product.description</p>
            </div>
            <a class="waves-effect waves-light btn-large disabled confirm" selection="@product.selection"><i class="material-icons left">shopping_cart</i>@product.price &euro; CONFERMA</a>
        </div>
    </div>
}

<div class="section step3 hidden">
    <h2 class="header center black-text">EROGAZIONE DEL PRODOTTO</h2>
    <div class="col s12">
        <div class="progress">
            <div class="determinate" style="width: 0%"></div>
        </div>
    </div>
</div>

@section js {
    <script type="text/javascript">
        $(function () {
            // CHECK PING
            checkCredit();

            // SELEZIONE CATEGORIA
            $('.step0 a').click(function () {
                var categoryID = $(this).attr('data-content');
                $('.step0').addClass('hidden');
                $('#' + categoryID).removeClass('hidden');
            });
            // SELEZIONE PRODOTTO
            $('.step1 a').click(function () {
                var productID = $(this).attr('data-content');
                $('.step1').addClass('hidden');
                $('#' + productID).removeClass('hidden');
                $('.breadcrumbs').append('<a href="#!" class="breadcrumb">2. Conferma</a>');
                checkCredit();
            });
            // CONFERMA PRODOTTO
            $('.confirm').click(function () {
                var selection = $(this).attr('selection');
                $(this).remove();
                $('.breadcrumbs').append('<a href="#!" class="breadcrumb">3. Erogazione</a>');
                $('.step2').addClass('hidden');
                $('.step3').removeClass('hidden');
                erogateProduct(selection);
                progressBar(0);
                setTimeout(function () { reset(); }, 5000);
            });

            $('.go-back').click(function () {
                reset();
            });
        });

        function reset() {
            $('.step0').removeClass('hidden');
            $('.step1:not(.hidden)').addClass('hidden');
            $('.step2:not(.hidden)').addClass('hidden');
            $('.step3:not(.hidden)').addClass('hidden');
            $('.confirm').addClass('disabled');
            $('.determinate').width('0%');
            $('.breadcrumbs').html('').append('<a href="#!" class="breadcrumb">1. Selezione</a>');
        }

        function progressBar(width) {
            if (width == 100)
                return;
            else {
                width += 1;
                $('.determinate').width(width + '%');
                setTimeout(function () { progressBar(width); }, 40);
            }
        }

        function checkCredit() {
            $.get("/Home/Credit", function (data, status) {
                if (data == 'pong')
                    $('.disabled').removeClass('disabled');
            });
        }

        function erogateProduct(selection) {
            $.post("/Home/Erogate",
                {
                    selection: selection
                },
                function (data, status) {
                    console.log(data);
                });
        }
    </script>
}